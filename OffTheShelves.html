<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Off the Shelves - E-Learning Repository</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #fefefe;
      color: #1a1a1a;
    }
    header {
      background: linear-gradient(90deg, #006400, #228B22);
      color: #fff;
      padding: 1rem;
      text-align: center;
    }
    header h1 {
      margin: 0;
      font-size: 1.5rem;
      color: gold;
    }
    main {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 1rem;
      padding: 1rem;
    }
    section {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 1rem;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    h2 {
      margin-top: 0;
      color: #006400;
    }
    label {
      display: block;
      margin: 0.5rem 0 0.25rem;
    }
    input, select, textarea, button {
      width: 100%;
      padding: 0.5rem;
      margin-bottom: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 0.9rem;
    }
    button {
      cursor: pointer;
      background: #228B22;
      color: #fff;
      font-weight: bold;
      transition: 0.3s;
    }
    button:hover {
      background: gold;
      color: #006400;
    }
    .file-list {
      list-style: none;
      padding: 0;
    }
    .file-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #f9f9f9;
      border: 1px solid #eee;
      border-radius: 6px;
      padding: 0.5rem;
      margin-bottom: 0.5rem;
    }
    .file-meta {
      flex: 1;
      margin-left: 0.5rem;
    }
    .file-icon {
      width: 24px;
      height: 24px;
      flex-shrink: 0;
    }
    .progress-bar {
      height: 6px;
      background: #eee;
      border-radius: 3px;
      overflow: hidden;
      margin-bottom: 0.5rem;
    }
    .progress {
      height: 100%;
      width: 0;
      background: #228B22;
    }
    .admin-actions button {
      margin: 0 2px;
      width: auto;
      font-size: 0.8rem;
      padding: 0.25rem 0.5rem;
    }
    .filters {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-bottom: 1rem;
    }
    .tag {
      display: inline-block;
      background: gold;
      color: #006400;
      padding: 2px 6px;
      border-radius: 4px;
      margin: 2px;
      font-size: 0.75rem;
    }
    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background: #fff;
      padding: 1rem;
      border-radius: 8px;
      width: 80%;
      max-width: 600px;
    }
    .modal-content textarea {
      height: 200px;
    }
  </style>
</head>
<body>
<header>
  <h1>Off the Shelves: E-Learning Repository</h1>
</header>
<main>
  <section aria-label="Upload Section">
    <h2>Upload Resource</h2>
    <form id="uploadForm">
      <label for="title">Title</label>
      <input type="text" id="title" required />
      <label for="course">Course</label>
      <select id="course" required>
        <option value="">--Select--</option>
        <option>Health Assessment</option>
        <option>Anatomy and Physiology</option>
        <option>Basic Concepts in Nursing</option>
        <option>Theoretical Foundations in Nursing</option>
      </select>
      <label for="year">Year Level</label>
      <select id="year" required>
        <option value="">--Select--</option>
        <option>1st Year</option>
        <option>2nd Year</option>
        <option>3rd Year</option>
        <option>4th Year</option>
      </select>
      <label for="type">Type</label>
      <select id="type" required>
        <option value="">--Select--</option>
        <option>Lecture</option>
        <option>Video</option>
        <option>Nursing Care Plan</option>
        <option>Return Demonstration</option>
      </select>
      <label for="tags">Tags (comma-separated)</label>
      <input type="text" id="tags" placeholder="e.g. vital signs, circulation" />
      <label for="description">Description</label>
      <textarea id="description"></textarea>
      <label><input type="checkbox" id="consent" required /> I confirm consent for storage and review</label>
      <label for="file">Select File</label>
      <input type="file" id="file" required />
      <div class="progress-bar"><div class="progress" id="progress"></div></div>
      <button type="submit">Upload</button>
    </form>
    <button onclick="showConsentForm()">View Consent Form</button>
  </section>
  <section aria-label="Repository Section">
    <h2>Repository</h2>
    <div class="filters">
      <input type="text" id="search" placeholder="Search..." />
      <select id="filterCourse"><option value="">All Courses</option></select>
      <select id="filterYear"><option value="">All Years</option></select>
      <select id="filterTag"><option value="">All Tags</option></select>
      <button onclick="exportBackup()">Export Backup</button>
      <input type="file" id="importFile" style="display:none" />
      <button onclick="document.getElementById('importFile').click()">Import Backup</button>
      <button onclick="adminLogin()">Admin</button>
      <button id="clearRepo" style="display:none" onclick="clearRepository()">Clear Repository</button>
    </div>
    <ul id="fileList" class="file-list" aria-live="polite"></ul>
  </section>
</main>

<!-- Consent Modal -->
<div class="modal" id="consentModal">
  <div class="modal-content">
    <h2>Consent Form</h2>
    <textarea id="consentText">I hereby consent to participate in the study entitled "Off the Shelves: Development of an E-learning Repository of Fundamental Nursing Concepts as a Supplementary Platform for PLM Nursing Students." I understand the purpose, risks, and benefits of this study and my right to withdraw anytime. I consent to the storage and use of my academic submissions for educational and research purposes only.</textarea>
    <button onclick="printConsent()">Print</button>
    <button onclick="closeConsentForm()">Close</button>
  </div>
</div>

<script>
// IndexedDB setup
const DB_NAME = 'NursingRepo';
const STORE_NAME = 'resources';
let db;
let isAdmin = false;
let adminPass;
const MAX_FILE_SIZE = 100 * 1024 * 1024; // 100MB

init();

function init() {
  // Check admin passcode
  adminPass = localStorage.getItem('adminPass');
  if (!adminPass) {
    const setPass = prompt('Set admin passcode for repository:');
    if (setPass) {
      localStorage.setItem('adminPass', setPass);
      adminPass = setPass;
    }
  }
  const request = indexedDB.open(DB_NAME, 1);
  request.onupgradeneeded = e => {
    db = e.target.result;
    if (!db.objectStoreNames.contains(STORE_NAME)) {
      db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
    }
  };
  request.onsuccess = e => { db = e.target.result; renderFiles(); };
}

// Upload form
const form = document.getElementById('uploadForm');
form.onsubmit = e => {
  e.preventDefault();
  const file = document.getElementById('file').files[0];
  if (!file) return;
  if (file.size > MAX_FILE_SIZE) { alert('File too large!'); return; }
  const reader = new FileReader();
  reader.onprogress = e => {
    if (e.lengthComputable) {
      document.getElementById('progress').style.width = (e.loaded / e.total * 100) + '%';
    }
  };
  reader.onload = () => {
    const data = {
      title: document.getElementById('title').value,
      course: document.getElementById('course').value,
      year: document.getElementById('year').value,
      type: document.getElementById('type').value,
      tags: document.getElementById('tags').value.split(',').map(t => t.trim()).filter(Boolean),
      description: document.getElementById('description').value,
      consent: document.getElementById('consent').checked,
      fileName: file.name,
      fileSize: file.size,
      fileType: file.type,
      data: reader.result,
      reviewed: false,
      date: new Date()
    };
    const tx = db.transaction(STORE_NAME, 'readwrite');
    tx.objectStore(STORE_NAME).add(data);
    tx.oncomplete = () => { renderFiles(); form.reset(); document.getElementById('progress').style.width = '0'; };
  };
  reader.readAsDataURL(file);
};

function renderFiles() {
  const list = document.getElementById('fileList');
  list.innerHTML = '';
  const tx = db.transaction(STORE_NAME, 'readonly');
  const req = tx.objectStore(STORE_NAME).getAll();
  req.onsuccess = () => {
    const files = req.result;
    files.forEach(f => {
      if (!filterMatch(f)) return;
      const li = document.createElement('li');
      li.className = 'file-item';
      const icon = document.createElement('div');
      icon.className = 'file-icon';
      icon.textContent = fileIcon(f.fileType);
      const meta = document.createElement('div');
      meta.className = 'file-meta';
      meta.innerHTML = `<strong>${f.title}</strong> (${f.fileName}, ${(f.fileSize/1024).toFixed(1)} KB)<br>${f.course} - ${f.year} - ${f.type}<br>${f.tags.map(t=>`<span class='tag'>${t}</span>`).join(' ')}<br>${f.reviewed?'<span style="color:green">Reviewed</span>':''}`;
      li.appendChild(icon);
      li.appendChild(meta);
      if (isAdmin) {
        const actions = document.createElement('div');
        actions.className = 'admin-actions';
        const reviewBtn = document.createElement('button');
        reviewBtn.textContent = f.reviewed?'Unreview':'Mark Reviewed';
        reviewBtn.onclick = ()=>toggleReview(f.id,f.reviewed);
        const delBtn = document.createElement('button');
        delBtn.textContent = 'Delete';
        delBtn.onclick = ()=>deleteFile(f.id);
        actions.appendChild(reviewBtn);
        actions.appendChild(delBtn);
        li.appendChild(actions);
      }
      list.appendChild(li);
    });
  };
}

function fileIcon(type) {
  if (type.includes('pdf')) return '📄';
  if (type.includes('video')) return '🎥';
  if (type.includes('image')) return '🖼️';
  if (type.includes('word')||type.includes('doc')) return '📝';
  return '📁';
}

function toggleReview(id, status) {
  const tx = db.transaction(STORE_NAME,'readwrite');
  const store = tx.objectStore(STORE_NAME);
  store.get(id).onsuccess = e=>{
    const f = e.target.result;
    f.reviewed = !status;
    store.put(f).onsuccess = renderFiles;
  };
}

function deleteFile(id) {
  const tx = db.transaction(STORE_NAME,'readwrite');
  tx.objectStore(STORE_NAME).delete(id).onsuccess = renderFiles;
}

function filterMatch(f) {
  const s = document.getElementById('search').value.toLowerCase();
  const c = document.getElementById('filterCourse').value;
  const y = document.getElementById('filterYear').value;
  const t = document.getElementById('filterTag').value;
  if (s && !f.title.toLowerCase().includes(s) && !f.description.toLowerCase().includes(s)) return false;
  if (c && f.course!==c) return false;
  if (y && f.year!==y) return false;
  if (t && !f.tags.includes(t)) return false;
  return true;
}

document.getElementById('search').oninput = renderFiles;
document.getElementById('filterCourse').onchange = renderFiles;
document.getElementById('filterYear').onchange = renderFiles;
document.getElementById('filterTag').onchange = renderFiles;

// Admin
function adminLogin() {
  const pass = prompt('Enter admin passcode:');
  if (pass===adminPass) { isAdmin=true; document.getElementById('clearRepo').style.display='inline'; renderFiles(); }
  else alert('Wrong passcode');
}

function clearRepository() {
  if (!confirm('Clear all repository data?')) return;
  const tx = db.transaction(STORE_NAME,'readwrite');
  tx.objectStore(STORE_NAME).clear().onsuccess=renderFiles;
}

// Export/Import
function exportBackup() {
  const tx = db.transaction(STORE_NAME,'readonly');
  tx.objectStore(STORE_NAME).getAll().onsuccess=e=>{
    const data = JSON.stringify(e.target.result);
    const blob = new Blob([data], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'erepo-backup.json';
    a.click();
  };
}

document.getElementById('importFile').onchange = e=>{
  const file = e.target.files[0];
  const reader = new FileReader();
  reader.onload = ()=>{
    const arr = JSON.parse(reader.result);
    const tx = db.transaction(STORE_NAME,'readwrite');
    arr.forEach(f=>tx.objectStore(STORE_NAME).add(f));
    tx.oncomplete = renderFiles;
  };
  reader.readAsText(file);
};

// Consent modal
function showConsentForm() { document.getElementById('consentModal').style.display='flex'; }
function closeConsentForm() { document.getElementById('consentModal').style.display='none'; }
function printConsent() {
  const text = document.getElementById('consentText').value;
  const win = window.open('', 'Print', 'height=600,width=800');
  win.document.write('<pre>'+text+'</pre>');
  win.print();
}
</script>
</body>
</html>

